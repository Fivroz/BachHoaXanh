@using BachHoaXanh.Models
@model List<Cart>
@{
    ViewBag.Title = "Giỏ hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
@if (Session["Cart"]==null) {
   <div class="text-center mt-2">
       <h2 class="text-center">Quý khách chưa có gì trong giỏ hàng ^^</h2>
       <a class="btn btn-primary text-center mt-5 " href="@Url.Action("TrangChu","Home")">Tiếp tục mua hàng</a>
   </div>
}
else {
<div class="card mt-4">
    <h2 style="text-align:center">Giỏ hàng của Bạn</h2>
    @foreach (var sp in Model)
    {
        <div class="card" style="margin: 10px;">
            <div class="row">
                <a style="flex-basis: fit-content" href="@Url.Action("CTSanPham", "Home", new { id = sp.MaSanPham })">
                    <img class="img-thumbnail" src="~/Styles/Image/SanPham/@sp.AnhSanPham"
                         style="height: 200px; width: 200px;">
                </a>
                <div class="col-3" style="margin-top: 3%;">
                    <h6>@sp.TenSanPham</h6>
                    <h6> @String.Format("{0:N0}", @sp.DonGia) đồng</h6>
                </div>
                <a class="bx bx-x" style="font-size: 24px; width: fit-content; height: fit-content; position: absolute; top: 5px; right: 5px; background-color: transparent; border: none; color: black; text-decoration: none; " onclick="confirmDelete(@sp.MaSanPham)"></a>
            </div>
            <div style="position: absolute; bottom: 10px; right: 15px;">
                <button class="decrease-btn" style=" border: none; font-size: 18px;" data-item="@sp.MaSanPham">-</button>
                <input id="quantity-label" disabled type="number" min="1" max="50" value="@sp.SoLuong" style="width: 40px; background: transparent; border: none;" data-item="@sp.MaSanPham">
                <button class="increase-btn" style=" border: none; font-size: 18px;" data-item="@sp.MaSanPham">+</button>
            </div>


        </div>
    }
    <hr>
    <div>
        <div style="float: right ; margin-right: 30px;">
            <strong>
                <p>Tổng số lượng: @ViewBag.TongSL sản phẩm</p>
                <p>Phí giao hàng:  @String.Format("{0:N0}", @ViewBag.PhiGiaoHang) đồng</p>
                <p>Tổng tiền:  @String.Format("{0:N0}", (@ViewBag.TongTien + ViewBag.PhiGiaoHang)) đồng</p>
            </strong>
        </div>
    </div>
    <div style="display: flex; justify-content: center; align-items: center;">
        <button id="btnPlaceOrder" class="btn btn-primary" data-url="@Url.Action("Create", "Cart")" onclick="checkLoggedIn()">Đặt hàng</button>
    </div>
    <div class="m-2 text-center" style="cursor:pointer">
        <i  class="bx bx-x-circle"></i>
        <a id="deleteCart" style="text-decoration: none; color: black;" onclick="confirmDeleteCart()"> Xóa giỏ hàng</a>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
        crossorigin="anonymous"></script>
<script>
    // Function to update the quantity of an item in the cart
          function updateQuantity(itemId, quantity) {
          // Make an AJAX request to the server to update the quantity
          $.ajax({
            url: '@Url.Action("UpdateQuantity", "Cart")',
            type: 'POST',
            data: { productId: itemId, quantity: quantity },
            success: function(response) {
              if (response.success) {
                  $('#quantity-label').text(quantity);
              } else {
                alert('Số lượng tồn không đủ! Xin thứ lỗi');
              }
            },
            error: function(jqXHR, textStatus, errorThrown) {
              alert('Có lỗi xảy ra khi cập nhật số lượng: ' + errorThrown);
            }
          });
        }



    // Function to handle the button click for decreasing the quantity
    function decreaseQuantity(itemId) {
        var input = $('input[data-item="' + itemId + '"]');
        var currentQuantity = parseInt(input.val());

        if (currentQuantity > 1) {
            var newQuantity = currentQuantity - 1;
            input.val(newQuantity);
            updateQuantity(itemId, newQuantity);
            location.reload();
        }
        else {
            alert('Số lượng không thể giảm thêm');
        }
    }

    // Function to handle the button click for increasing the quantity
    function increaseQuantity(itemId) {
        var input = $('input[data-item="' + itemId + '"]');
        var currentQuantity = parseInt(input.val());
        var newQuantity = currentQuantity + 1;

        if (newQuantity <= 50) { // Check if the new quantity is within the range
            input.val(newQuantity);
            updateQuantity(itemId, newQuantity);
            location.reload();
        }
        else {
            alert('Số lượng tối đa đã đạt được');
        }
    }


    // Bind the click event to the decrease and increase buttons
    $(document).on('click', '.decrease-btn', function() {
        var itemId = $(this).data('item');
        decreaseQuantity(itemId);
    });

    $(document).on('click', '.increase-btn', function() {
        var itemId = $(this).data('item');
        increaseQuantity(itemId);
    });


    function confirmDelete(maSP) {
    // Show the alert with a confirmation message
    if (confirm('Bạn muốn xóa mặt hàng này?')) {
        var url = '/Cart/DeleteOne?MaSP=' + encodeURIComponent(maSP);

        $.ajax({
            url: url,
            type: 'POST',
            success: function () {
                alert('Đã xóa mặt hàng! ^^');
                location.reload();
            },
            error: function () {
                alert('Đã có lỗi xảy ra. Vui lòng thử lại!');
            }
        });
    }
}
    function confirmDeleteCart() {
        // Show the alert with a confirmation message
        if (confirm('Bạn muốn xóa giỏ hàng?')) {
            $.ajax({
                url: '@Url.Action("DeleteCart", "Cart")',
                type: 'POST',
                success: () => { alert('Xóa thành công! ^^') },
                error: () => { alert('Đã có lỗi xảy ra. Vui lòng thử lại!') }
            });
            location.reload();
        }
    }

   //Dat hang
   function checkLoggedIn() {
        var loggedIn = '@Session["ID_USER"]';

        if (loggedIn != null && loggedIn !== '') {
            // User is logged in, show the modal
            openCreateModal();
        } else {
            // User is not logged in, redirect to the login page
            alert('Bạn phải đăng nhập trước đã ^^')
            window.location.href = '@Url.Action("Login", "Home")';
        }
    }

</script>


@*Modal Đặt hàng*@
<div class="modal fade" id="createModal" tabindex="-1" role="dialog" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createModalLabel">Xác nhận đặt hàng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <iframe id="createModalFrame" width="100%" height="400px" frameborder="0"></iframe>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jquery")
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <script>
        function openCreateModal() {
            var url = $("#btnPlaceOrder").data('url');
            $("#createModalFrame").attr("src", url);
            $("#createModal").modal("show");
        }
        $(document).ready(function () {
            $("#btnPlaceOrder").click(function () {
                openCreateModal();
            });
            $("#createModal").on("hidden.bs.modal", function () {
                location.reload();
            });      
        });
    </script>
}
}
